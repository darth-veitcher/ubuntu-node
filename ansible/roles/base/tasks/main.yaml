---
# file: roles/base/tasks/main.yaml
# Contains basic setup tasks for Ubuntu
- name: Configure SSH
  import_tasks: library/ssh_setup.yaml # TODO: replace `include` with `include_tasks` due to deprecation

- include_tasks: library/request-new-code.yml
  tags: google-auth
  when: use_mfa is defined and use_mfa|bool
# Gather facts now we've established SSH
- name: Collect facts post-SSH config
  ansible.builtin.setup:

# Hostname
- name: Set hostname to inventory hostname
  hostname: name={{inventory_hostname}}

# APT
- include_tasks: apt.yaml # TODO: replace `include` with `include_tasks` due to deprecation

# Logwatch
- include_tasks: logwatch.yaml # TODO: replace `include` with `include_tasks` due to deprecation
  when: logwatch_email is defined and logwatch_email|length > 0

# Users
- include_tasks: users.yaml # TODO: replace `include` with `include_tasks` due to deprecation

# SSH and Firewall hardening
- include_tasks: ssh.yaml # TODO: replace `include` with `include_tasks` due to deprecation
- include_tasks: firewall.yaml # TODO: replace `include` with `include_tasks` due to deprecation

# Avahi service discovery (optional)
- include_tasks: avahi.yaml # TODO: replace `include` with `include_tasks` due to deprecation
  when: enable_avahi is undefined or enable_avahi|bool is true

# Disable history
- name: disable bash history
  become: "{{ item }}"
  shell: echo 'alias exit="kill -9 $$"' >> ~/.bashrc
  loop:
    - true
    - false
